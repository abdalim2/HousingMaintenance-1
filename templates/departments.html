{% extends "layout.html" %}

{% block page_title %}Departments{% endblock %}

{% block header_actions %}
<button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
    <i class="fas fa-plus"></i> Add Department
</button>
{% endblock %}

{% block content %}
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Department List</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>BioTime ID</th>
                        <th>Employees</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dept in departments %}
                    <tr>
                        <td>{{ dept.id }}</td>
                        <td>{{ dept.name }}</td>
                        <td>{{ dept.dept_id }}</td>
                        <td>{{ dept.employees|length }}</td>
                        <td>
                            {% if dept.active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="viewDepartment({{ dept.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning"
                                        onclick="editDepartment({{ dept.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        onclick="deleteDepartment({{ dept.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No departments found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Department Employees Card -->
<div class="card bg-dark">
    <div class="card-header">
        <h5 class="card-title mb-0">Department Employees</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <select class="form-select" id="department-filter">
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search employees..." id="employee-search">
                    <button class="btn btn-primary" type="button" id="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Name</th>
                        <th>Profession</th>
                        <th>Daily Hours</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employee-list">
                    <tr>
                        <td colspan="6" class="text-center">Select a department to view employees</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Edit Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm">
                    <input type="hidden" id="empId">
                    <div class="mb-3">
                        <label for="empCode" class="form-label">Employee Code</label>
                        <input type="text" class="form-control" id="empCode" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="empName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="empName" required>
                    </div>
                    <div class="mb-3">
                        <label for="empProfession" class="form-label">Profession</label>
                        <input type="text" class="form-control" id="empProfession">
                    </div>
                    <div class="mb-3">
                        <label for="empDailyHours" class="form-label">Daily Working Hours</label>
                        <input type="number" class="form-control" id="empDailyHours" value="8.0" min="1" max="24" step="0.5" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="empActive" checked>
                        <label class="form-check-label" for="empActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEmployee">Save Employee</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1" aria-labelledby="addDepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="addDepartmentModalLabel">Add New Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDepartmentForm">
                    <div class="mb-3">
                        <label for="deptName" class="form-label">Department Name</label>
                        <input type="text" class="form-control" id="deptName" required>
                    </div>
                    <div class="mb-3">
                        <label for="deptId" class="form-label">BioTime Department ID</label>
                        <input type="text" class="form-control" id="deptId" required>
                        <div class="form-text">
                            This is the department ID used in BioTime system
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="deptActive" checked>
                        <label class="form-check-label" for="deptActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDepartment">Save Department</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Department functions
        window.viewDepartment = function(deptId) {
            // Set the department filter dropdown to the selected department
            document.getElementById('department-filter').value = deptId;
            
            // Load real employee data from API
            loadEmployeesByDepartment(deptId);
        };
        
        // Function to load employees from the API
        function loadEmployeesByDepartment(deptId) {
            const employeeList = document.getElementById('employee-list');
            employeeList.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading employees...</td></tr>';
            
            // Fetch employees from the API
            fetch(`/api/employees/department/${deptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.employees.length > 0) {
                        let html = '';
                        data.employees.forEach(emp => {
                            let statusBadge = emp.active ? 
                                '<span class="badge bg-success">Active</span>' : 
                                '<span class="badge bg-danger">Inactive</span>';
                                
                            html += `
                                <tr>
                                    <td>${emp.emp_code}</td>
                                    <td>${emp.name}</td>
                                    <td>${emp.profession || ''}</td>
                                    <td>${emp.daily_hours}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-sm btn-outline-info" onclick="viewEmployeeDetails(${emp.id})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editEmployee(${emp.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <a href="{{ url_for('employee_performance') }}?id=${emp.id}" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-chart-line" title="تحليل أداء الموظف"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        employeeList.innerHTML = html;
                    } else {
                        employeeList.innerHTML = '<tr><td colspan="6" class="text-center">No employees found for this department</td></tr>';
                    }
                })
                .catch(error => {
                    console.error("Error loading employees:", error);
                    employeeList.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading employees. Please try again.</td></tr>';
                });
        }
        
        // Edit employee function
        window.editEmployee = function(empId) {
            // Fetch employee details
            fetch(`/api/employees/${empId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const employee = data.employee;
                        
                        // Populate the edit form
                        document.getElementById('empId').value = employee.id;
                        document.getElementById('empCode').value = employee.emp_code;
                        document.getElementById('empName').value = employee.name;
                        document.getElementById('empProfession').value = employee.profession || '';
                        document.getElementById('empDailyHours').value = employee.daily_hours;
                        document.getElementById('empActive').checked = employee.active;
                        
                        // Show the modal
                        const editModal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                        editModal.show();
                    } else {
                        alert('Error loading employee details: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error("Error fetching employee details:", error);
                    alert('Error loading employee details. Please try again.');
                });
        };
        
        // View employee details
        window.viewEmployeeDetails = function(empId) {
            // Just use the edit function for now, but without editing capability
            editEmployee(empId);
        };
        
        window.editDepartment = function(deptId) {
            // In a real implementation, this would fetch department data and populate a modal
            alert(`Edit department ${deptId}`);
        };
        
        window.deleteDepartment = function(deptId) {
            if (confirm(`Are you sure you want to delete department ${deptId}?`)) {
                // In a real implementation, this would send a delete request to the server
                alert(`Department ${deptId} would be deleted`);
            }
        };
        
        // Department filter change event
        document.getElementById('department-filter').addEventListener('change', function() {
            const deptId = this.value;
            if (deptId) {
                loadEmployeesByDepartment(deptId);
            } else {
                document.getElementById('employee-list').innerHTML = 
                    '<tr><td colspan="6" class="text-center">Select a department to view employees</td></tr>';
            }
        });
        
        // Save department button
        document.getElementById('saveDepartment').addEventListener('click', function() {
            const name = document.getElementById('deptName').value;
            const bioTimeId = document.getElementById('deptId').value;
            const active = document.getElementById('deptActive').checked;
            
            if (!name || !bioTimeId) {
                alert('Please fill out all required fields');
                return;
            }
            
            // In a real implementation, this would send data to the server
            alert(`Department would be saved: ${name} (${bioTimeId}) - Active: ${active}`);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDepartmentModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('addDepartmentForm').reset();
        });
        
        // Save employee button
        document.getElementById('saveEmployee').addEventListener('click', function() {
            const empId = document.getElementById('empId').value;
            const name = document.getElementById('empName').value;
            const profession = document.getElementById('empProfession').value;
            const dailyHours = document.getElementById('empDailyHours').value;
            const active = document.getElementById('empActive').checked;
            
            if (!name || !dailyHours) {
                alert('Please fill out all required fields');
                return;
            }
            
            // Validate daily hours
            const hours = parseFloat(dailyHours);
            if (isNaN(hours) || hours <= 0 || hours > 24) {
                alert('Daily hours must be a number between 0.5 and 24');
                return;
            }
            
            // Send update to the server
            fetch(`/api/employees/${empId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    profession: profession,
                    daily_hours: hours,
                    active: active
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal'));
                    modal.hide();
                    
                    // Refresh the employee list
                    const deptId = document.getElementById('department-filter').value;
                    if (deptId) {
                        loadEmployeesByDepartment(deptId);
                    }
                    
                    alert('Employee updated successfully');
                } else {
                    alert('Error updating employee: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating employee:', error);
                alert('Error updating employee. Please try again.');
            });
        });
        
        // Search employees
        document.getElementById('search-btn').addEventListener('click', function() {
            const searchTerm = document.getElementById('employee-search').value.trim();
            const deptId = document.getElementById('department-filter').value;
            
            if (!deptId) {
                alert('Please select a department first');
                return;
            }
            
            if (searchTerm) {
                // In a real implementation, this would filter employees by search term
                alert('Search functionality will be implemented in future updates');
            } else {
                loadEmployeesByDepartment(deptId);
            }
        });
    });
</script>
{% endblock %}
