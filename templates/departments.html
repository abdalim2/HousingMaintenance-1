{% extends "layout.html" %}

{% block page_title %}Departments{% endblock %}

{% block header_actions %}
<button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
    <i class="fas fa-plus"></i> Add Department
</button>
{% endblock %}

{% block content %}
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Department List</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>BioTime ID</th>
                        <th>Employees</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dept in departments %}
                    <tr>
                        <td>{{ dept.id }}</td>
                        <td>{{ dept.name }}</td>
                        <td>{{ dept.dept_id }}</td>
                        <td>{{ dept.employees|length }}</td>
                        <td>
                            {% if dept.active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="viewDepartment({{ dept.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning"
                                        onclick="editDepartment({{ dept.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        onclick="deleteDepartment({{ dept.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No departments found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Department Employees Card -->
<div class="card bg-dark">
    <div class="card-header">
        <h5 class="card-title mb-0">Department Employees</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <select class="form-select" id="department-filter">
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search employees..." id="employee-search">
                    <button class="btn btn-primary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Name</th>
                        <th>Profession</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employee-list">
                    <tr>
                        <td colspan="5" class="text-center">Select a department to view employees</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1" aria-labelledby="addDepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="addDepartmentModalLabel">Add New Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDepartmentForm">
                    <div class="mb-3">
                        <label for="deptName" class="form-label">Department Name</label>
                        <input type="text" class="form-control" id="deptName" required>
                    </div>
                    <div class="mb-3">
                        <label for="deptId" class="form-label">BioTime Department ID</label>
                        <input type="text" class="form-control" id="deptId" required>
                        <div class="form-text">
                            This is the department ID used in BioTime system
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="deptActive" checked>
                        <label class="form-check-label" for="deptActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDepartment">Save Department</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Department functions
        window.viewDepartment = function(deptId) {
            // Set the department filter dropdown to the selected department
            document.getElementById('department-filter').value = deptId;
            
            // Simulate loading employee data
            const employeeList = document.getElementById('employee-list');
            employeeList.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading employees...</td></tr>';
            
            setTimeout(() => {
                // This would be replaced with actual AJAX call to get employees
                const sampleEmployees = [
                    { code: '40297', name: 'محمد حسن علي الحسيني', profession: 'عامل', status: 'active' },
                    { code: '20790', name: 'منصور الدين ليثي', profession: 'سوداني عامل', status: 'active' },
                    { code: '41842', name: 'عبدالرحمن يوسف', profession: 'عامل', status: 'active' },
                    { code: '34187', name: 'زهران فتحي محمد قناوي', profession: 'سباك', status: 'active' },
                    { code: '42768', name: 'جميولتيرين دي سالم جميولتيرين', profession: 'حداد', status: 'active' }
                ];
                
                let html = '';
                sampleEmployees.forEach(emp => {
                    html += `
                        <tr>
                            <td>${emp.code}</td>
                            <td>${emp.name}</td>
                            <td>${emp.profession}</td>
                            <td><span class="badge bg-success">Active</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                employeeList.innerHTML = html;
            }, 1000);
        };
        
        window.editDepartment = function(deptId) {
            // In a real implementation, this would fetch department data and populate a modal
            alert(`Edit department ${deptId}`);
        };
        
        window.deleteDepartment = function(deptId) {
            if (confirm(`Are you sure you want to delete department ${deptId}?`)) {
                // In a real implementation, this would send a delete request to the server
                alert(`Department ${deptId} would be deleted`);
            }
        };
        
        // Department filter change event
        document.getElementById('department-filter').addEventListener('change', function() {
            const deptId = this.value;
            if (deptId) {
                viewDepartment(deptId);
            } else {
                document.getElementById('employee-list').innerHTML = 
                    '<tr><td colspan="5" class="text-center">Select a department to view employees</td></tr>';
            }
        });
        
        // Save department button
        document.getElementById('saveDepartment').addEventListener('click', function() {
            const name = document.getElementById('deptName').value;
            const bioTimeId = document.getElementById('deptId').value;
            const active = document.getElementById('deptActive').checked;
            
            if (!name || !bioTimeId) {
                alert('Please fill out all required fields');
                return;
            }
            
            // In a real implementation, this would send data to the server
            alert(`Department would be saved: ${name} (${bioTimeId}) - Active: ${active}`);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDepartmentModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('addDepartmentForm').reset();
        });
    });
</script>
{% endblock %}
